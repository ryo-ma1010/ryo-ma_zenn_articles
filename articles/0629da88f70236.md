---
title: "claudeã¨ã¨ã‚‚ã«æ­©ã‚“ã awsãƒªã‚½ãƒ¼ã‚¹ã®terraformåŒ–ã¸ã®é“"
emoji: "ğŸ¦”"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["aws", "terraform"]
published: true
---
## ã¯ã˜ã‚ã«
AWSã¨TerraformæœªçµŒé¨“ã®è‡ªåˆ†ãŒ
AIã¨å”åƒã§æ—¢å­˜ãƒªã‚½ãƒ¼ã‚¹ã®terraformåŒ–ã‚’ç›®æŒ‡ã—ã¾ã—ãŸã€‚

- Terraform: 1.12.2
- AWS Provider: 5.94.1

## æ§‹æˆå›³ã‚’ä½œã‚‹
ä»Šå›TerraformåŒ–ã™ã‚‹ç’°å¢ƒã¯ã€ã™ã§ã«AWSã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ä¸Šã«ã‚ã‚Šã¾ã—ãŸã€‚
ãã®ç’°å¢ƒã‚’ä½œã£ãŸã®ã¯è‡ªåˆ†ã§ã—ãŸãŒã€è¦‹ã‚ˆã†è¦‹ã¾ã­ã§ä½œã£ãŸã®ã§ã€ãƒªã‚½ãƒ¼ã‚¹é–“ã®ä¾å­˜é–¢ä¿‚ã§ã‚ã‚‹ã¨ã‹ãŒã‚ˆãã‚ã‹ã£ã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚
ãªã®ã§ã€æ§‹æˆå›³ã‚’ä½œã‚‹ã“ã¨ã«ã—ã¾ã—ãŸ(ä»Šæ›´)ã€‚

ãŸã ã€è‡ªåˆ†ã®ç†è§£ã®ã¿ã§ã¯æ§‹æˆå›³ã‚’ä½œã‚ŒãŸã¨ã—ã¦ã‚‚ãã®å¾Œã®é–‹ç™ºã«æ´»ã‹ã›ã‚‹è‡ªä¿¡ãŒãªã‹ã£ãŸã®ã§ã€Claude Codeã¨å”åŠ›ã—ã¦ä½œã‚Šã¾ã—ãŸã€‚
Claude Codeã«ã¯åˆ¶ä½œéç¨‹ã‚‚å«ã‚ã¦æ§‹æˆå›³ã‚’èª­ã¿å–ã£ã¦ã‚‚ã‚‰ã„ã€ãã®å¾Œã®é–‹ç™ºã®é“æ¨™ã«ãªã£ã¦ã‚‚ã‚‰ã†ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

ä½œæˆã•ã‚ŒãŸæ§‹æˆå›³ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªå½¢ã«ãªã‚Šã¾ã—ãŸã€‚

![](/images/dev-architecture.png)

æ§‹æˆå›³ã®svgã‚’è¦‹ã›ã‚‹ã¨ã€ã„ã„æ„Ÿã˜ã«ç†è§£ã—ã¦ãã‚Œã¦ã€ã‚ã¨ã¯ä½œæ¥­ä¸­ã®è£œè¶³èª¬æ˜ã ã‘ã§è©±ãŒé€šã˜ã¾ã—ãŸã€‚
ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã‚’ä½œã£ã¦ãã‚Œã¾ã—ãŸã€‚

```bash
â¯ tree -L 1 -d
.
â”œâ”€â”€ acm
â”œâ”€â”€ alb
â”œâ”€â”€ codedeploy
â”œâ”€â”€ ecr
â”œâ”€â”€ ecs
â”œâ”€â”€ elasticache
â”œâ”€â”€ env
â”œâ”€â”€ firehose
â”œâ”€â”€ gitlab
â”œâ”€â”€ iam
â”œâ”€â”€ modules
â”œâ”€â”€ rds
â”œâ”€â”€ s3
â”œâ”€â”€ secrets_manager
â”œâ”€â”€ security_group
â””â”€â”€ vpc
```

## importä½œæ¥­
claude codeãŒimportã‚’é–‹å§‹ã™ã‚‹ã«ã‚ãŸã£ã¦ã€aws cliã‚³ãƒãƒ³ãƒ‰ã‚’å©ãå§‹ã‚ã¾ã—ãŸã€‚
å€‹äººæƒ…å ±ã‚’å©ãã¾ãã‚‹å§¿å‹¢ã«ææ€–ã—ãŸã®ã§ã€å¿…è¦ãªæƒ…å ±ã®åˆ—æŒ™ã ã‘ã—ã¦ã‚‚ã‚‰ã£ã¦ã€ãã®æƒ…å ±ã‚’è‡ªã‚‰bashã§å–å¾—ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚
ãã—ã¦å¾—ãŸæƒ…å ±ã‚’claude codeã«æŠ•ã’ãŸã¨ã“ã‚ã€ã„ã„æ„Ÿã˜ã«import.tfã‚’ä½œã£ã¦ãã‚Œã¾ã—ãŸã€‚

```hcl
# <service>/import.tf ã‚’ä½œæˆ
import {
  to = module.<module_name>.aws_<resource_type>.<resource_name>["<key>"]
  id = "<aws_resource_id>"
}
```

ãã®å¾Œã€terraformã‚³ãƒãƒ³ãƒ‰ã‚’å©ã„ã¦generated.tfã‚’ä½œã‚Šã¾ã™ã€‚

```bash
> terraform plan -generate-config-out=generated.tf
```


:::message
ã“ã“ã§ã¯ã€import.tfã‚’Claude Codeã«ä½œæˆã—ã¦ã‚‚ã‚‰ã„ã€bashã‚³ãƒãƒ³ãƒ‰ã¯è‡ªèº«ã®æ‰‹ã§ã‚„ã£ã¦ã„ã¾ã™ã€‚
ãŸã ã€Claude Codeã®ç·¨é›†ã§å¤‰æ›´å·®åˆ†ãŒã‚ã¡ã‚ƒãã¡ã‚ƒãƒ‡ã‚«ã‹ã£ãŸå ´åˆã¯ã€ç·¨é›†ã‚’æ‹’å¦ã—ã¦è‡ªåˆ†ãŒç·¨é›†ã—ã¦ã„ã¾ã™ã€‚
Claude Codeã«ä½•ã‚’ã—ã‚ˆã†ã¨ã—ãŸã®ã‹ã‚’è³ªå•ã—ã¦ã‚¿ã‚¹ã‚¯åŒ–ã—ã¦ã‚‚ã‚‰ã„ã€ãã®ã‚¿ã‚¹ã‚¯ã‚’è‡ªåˆ†ãŒæ¶ˆåŒ–ã—ã¦ã„ãã¨ã„ã†å½¢ã§ã™ã€‚
:::

## å¤‰æ•°åŒ–ã¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–
importã•ã‚ŒãŸtfãƒ•ã‚¡ã‚¤ãƒ«ã¯ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚ãªã®ã§ã€ãã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ•°ã«ç½®ãæ›ãˆã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ã¾ãŸã€é–‹ç™ºç’°å¢ƒã¨æœ¬ç•ªç’°å¢ƒã¨ãŒã‚ã‚‹ã®ã§ã€ãã®åˆ†terraformåŒ–ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ãã‚Œã‚’è¸ã¾ãˆã¦ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–ã—ã¦æœ¬ç•ªã¨é–‹ç™ºã§ã„ã„æ„Ÿã˜ã«ã‚³ãƒ¼ãƒ‰ã‚’å…±æœ‰ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹å¿…è¦ã‚‚ã‚ã‚Šã¾ã™ã€‚

ã“ã“ã§ã®é–‹ç™ºä½œæ¥­è‡ªä½“ã‚‚åŸºæœ¬äººåŠ›ã§ã‚„ã£ã¦ã„ã¾ã™ã€‚Claude Codeã«ã¯ãƒªã‚½ãƒ¼ã‚¹ãŒãªãœã“ã®ã‚ˆã†ãªå€¤ã«ãªã£ã¦ã„ã‚‹ã‹ã€ã¨ã„ã£ãŸåŸºæœ¬çš„ãªã“ã¨ã°ã‹ã‚Šè³ªå•ã—ã¦ã„ã¾ã™ã€‚
importä½œæ¥­ã®ã¨ãã¨åŒæ§˜ã«ã€å·¨å¤§ãªå¤‰æ›´å·®åˆ†ã‚’æç¤ºã•ã‚Œã‚‹ã¨ç§ãŒæ··ä¹±ã™ã‚‹ã®ã§ãã†ã„ã†å ´åˆã¯è‡ªåˆ†ã§ã‚„ã‚‹ã—ã‹ãªã„ã§ã™ã€‚

ã¡ãªã¿ã«æœ€çµ‚çš„ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã¯ä»¥ä¸‹ã®å½¢ã«ãªã‚Šã¾ã™(ä¾‹: ECS)

```bash
â”œâ”€â”€ ecs
â”‚   â””â”€â”€ dev
â”‚       â”œâ”€â”€ common.tf -> ../../env/common.tf
â”‚       â”œâ”€â”€ ecs.tf
â”‚       â”œâ”€â”€ import.tf
â”‚       â”œâ”€â”€ import.tfvars
â”‚       â”œâ”€â”€ outputs.tf
â”‚       â””â”€â”€ variables.tf
â”œâ”€â”€ modules
â”‚   â”œâ”€â”€ ecs
â”‚   â”‚   â”œâ”€â”€ main.tf
â”‚   â”‚   â”œâ”€â”€ outputs.tf
â”‚   â”‚   â””â”€â”€ variables.tf
```

## plan apply
ã‚ã‚‹ç¨‹åº¦tfãƒ•ã‚¡ã‚¤ãƒ«ãŒå®Œæˆã—ã¦ããŸã‚‰ã€planã—ã¦importãŒæ­£å¸¸ã«è¡Œãˆã‚‹ã‹ã©ã†ã‹ã€applyã—ã¦importå†…å®¹ã‚’stateãƒ•ã‚¡ã‚¤ãƒ«ã«åæ˜ ã—ã¾ã™ã€‚
planã‚„applyæ™‚ã«destroyã®å·®åˆ†ãŒç™ºç”Ÿã™ã‚‹å ´åˆã¯éƒ½åº¦Claude Codeã«è³ªå•ã—ã¦åŸå› ã¨ãã®å¯¾ç­–ã‚’æ•™ãˆã¦ã‚‚ã‚‰ã£ã¦ã„ã¾ã—ãŸã€‚

## ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
ã‚ã‚‹ç¨‹åº¦ã®å¤‰æ•°åŒ–ã‚„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–ãŒã§ããŸã‚‰ã€ã•ã‚‰ã«å…±é€šåŒ–ã™ã‚‹ã¹ãã€ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã‚’ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
terraform_remote_stateã‚’ä½¿ã£ãŸã‚Šã€resourceã®é…ç½®ã«ä¸æ•´åˆãŒç”Ÿã˜ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
ãã®ã¨ãã¯ã€Claude Codeã‹ã‚‰terraform MCPç­‰ã‚’ä½¿ã£ã¦ä»•æ§˜ã‚’æ•™ãˆã¦ã‚‚ã‚‰ã£ã¦å®Ÿè£…ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

ä¾‹ãˆã°terraform_remote_stateã‚’ä½¿ã†ãŸã‚ã«outputãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½œã‚‰ãªã„ã¨ã„ã‘ãªã„ã§ã‚ã‚‹ã¨ã‹ã€ãƒªã‚½ãƒ¼ã‚¹åã®å¤‰æ›´ã‚’åŒã˜tfãƒ•ã‚¡ã‚¤ãƒ«å†…ã§è¡Œã†ãŸã‚ã«ã¯movedãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½¿ã†å¿…è¦ãŒã‚ã‚‹ã€ã¨ã„ã£ãŸã“ã¨ã‚’Claude Codeã«æ•™ãˆã¦ã‚‚ã‚‰ã„ã¾ã—ãŸã€‚

## çµå±€äººåŠ›ã§ã‚„ã£ã¦ã„ã‚‹
è³ªå•ã—ãŸã„ã“ã¨ã¯è³ªå•ã—ã¦ã€Claude Codeã®æŒã¡å‘³ã§ã‚ã‚‹ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚„bashã®è‡ªå‹•å®Ÿè¡Œã¨ã„ã£ãŸæ©Ÿèƒ½ã¯ã€æ€–ãã¦ã‚ã¾ã‚Šä½¿ãˆã¦ã„ãªã„ã¨ã„ã†ã®ãŒç¾çŠ¶ã§ã™ã€‚
æ¥­å‹™ã§ä½¿ã£ã¦ã„ã‚‹ã®ã§ãã“ã«ææ€–ã™ã‚‹ã®ã¯å€‹äººçš„ã«ã¯æ­£ã—ã„è¡Œå‹•ã ã¨æ€ã†ã‚‚ã®ã®ã€ã¨ã¯ã„ãˆçµå±€äººåŠ›ã§ã‚„ã£ã¦ã„ã‚‹ã®ã§ã¯ã€ã¡ã‚‡ã£ã¨å‰ã®chatGPTã¨ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã¯å¤‰ã‚ã‚‰ãªã„ã§ã™ã€‚
ãªã®ã§ã€CLAUDE.mdã‚’è‡ªèº«ã§è‚²ã¦ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã¨ã„ã†ã“ã¨ã§ã€ä¸€é€šã‚ŠterraformåŒ–ã¯çµ‚ã‚ã‚‰ã›ã¦ã„ã¾ã—ãŸãŒ
ã€Œã“ã®AWSã‚µãƒ¼ãƒ“ã‚¹ã«ã¤ã„ã¦ã€arnã¨ã‹æ•™ãˆã¦ã‚‹ã®ã§importã—ã¦ãã‚Œãªã„ï¼Ÿã€
ã¿ãŸã„ãªæ„Ÿã˜ã®å‘½ä»¤ã‚’ã—ãŸã‚‰importã—ã¦ãã‚Œã‚‹ã‚ˆã†ãªCLAUDE.mdã‚’ä½œã£ã¦ã‚‚ã‚‰ã„ã¾ã—ãŸã€‚(æœªæ¤œè¨¼)

## ã§ããŸCLAUDE.md
ã“ã®æ‰‹é †ã‚’Claude Codeã«å­¦ç¿’ã—ã¦ã‚‚ã‚‰ã„ã€importä½œæ¥­ã‚’æ‰‹ä¼ã£ã¦ã‚‚ã‚‰ã„ã¾ã™ã€‚
ä»Šæ›´æ„ŸãŒã™ã”ã„ãŒã€æ¬¡ã®é–‹ç™ºã«æ´»ã‹ã—ãŸã„

:::details å®Œæˆã—ãŸCLAUDE.md
````md
### ç¢ºç«‹ã•ã‚ŒãŸæ¨™æº–æ‰‹é †

æ—¢å­˜ã®AWSã‚¤ãƒ³ãƒ•ãƒ©ã‚’Terraformã§ç®¡ç†ä¸‹ã«ç½®ãéš›ã¯ã€ä»¥ä¸‹ã®ãƒ—ãƒ­ã‚»ã‚¹ã«å¾“ã£ã¦ãã ã•ã„ï¼š

#### Phase 1: import.tfä½œæˆã¨ãƒªã‚½ãƒ¼ã‚¹ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

**1-1. import.tfã®ä½œæˆ**
```hcl
# <service>/dev/import.tf ã‚’ä½œæˆ
import {
  to = module.<module_name>.aws_<resource_type>.<resource_name>["<key>"]
  id = "<aws_resource_id>"
}
```

**IAMãƒªã‚½ãƒ¼ã‚¹ã®import IDå½¢å¼:**
- `aws_iam_role_policy_attachment`: `<role_name>/<policy_arn>` (ã‚¹ãƒ©ãƒƒã‚·ãƒ¥åŒºåˆ‡ã‚Š)
  - ä¾‹: `my-app-pipeline-role/arn:aws:iam::aws:policy/SecretsManagerReadWrite`
- `aws_iam_role_policy` (inline): `<role_name>:<policy_name>` (ã‚³ãƒ­ãƒ³åŒºåˆ‡ã‚Š)
  - ä¾‹: `my-app-pipeline-role:MyInlinePolicy`

**1-2. importå®Ÿè¡Œ**
```bash
cd <service>/dev
terraform plan -var-file=../../env/dev.tfvars
# "Plan: N to import, 0 to add, 0 to change, 0 to destroy" ã‚’ç¢ºèª
terraform apply -var-file=../../env/dev.tfvars
```

**1-3. import.tfã®å‰Šé™¤**
```bash
rm import.tf  # importå®Œäº†å¾Œã¯ä¸è¦
```

#### Phase 2: ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹é€ ã®ä½œæˆ

**2-1. ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ **
```bash
mkdir -p modules/<service>
mkdir -p <service>/dev
```

**2-2. modules/<service>/main.tfä½œæˆ**
```hcl
# for_eachãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¡ç”¨ï¼ˆECRãƒ»GitLabãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‚è€ƒï¼‰
resource "aws_iam_role_policy" "inline_policies" {
  for_each = var.inline_policies

  name   = each.value.policy_name
  role   = var.role_name
  policy = each.value.policy_document
}

resource "aws_iam_role_policy_attachment" "managed_policies" {
  for_each = var.managed_policies

  role       = var.role_name
  policy_arn = each.value.policy_arn
}
```

**2-3. modules/<service>/variables.tfä½œæˆ**
```hcl
variable "role_name" {
  description = "IAM role name"
  type        = string
}

variable "inline_policies" {
  description = "Inline policies"
  type = map(object({
    policy_name     = string
    policy_document = string
  }))
  default = {}
}

variable "managed_policies" {
  description = "Managed policies"
  type = map(object({
    policy_arn = string
  }))
  default = {}
}
```

**2-4. <service>/dev/<service>.tfä½œæˆ**
```hcl
module "<service>" {
  source = "../../modules/<service>"

  role_name         = "<role_name>"
  inline_policies   = local.inline_policies
  managed_policies  = local.managed_policies
}

locals {
  managed_policies = {
    policy_name = {
      policy_arn = "arn:aws:iam::aws:policy/PolicyName"
    }
  }

  inline_policies = {
    policy_name = {
      policy_name = "PolicyName"
      policy_document = jsonencode({
        Statement = [
          {
            Action   = ["service:Action"]
            Effect   = "Allow"
            Resource = "arn:aws:service:region:account:resource"
          }
        ]
        Version = "2012-10-17"
      })
    }
  }
}
```

**2-5. common.tfã®ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ä½œæˆ**
```bash
cd <service>/dev
ln -sf ../../env/common.tf common.tf
```

#### Phase 3: å¤‰æ•°åŒ–ã¨å‹•çš„å‚ç…§

**3-1. ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã®æ®µéšçš„è§£æ¶ˆ**
```hcl
# åˆæœŸ: ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ï¼ˆimportç›´å¾Œã¯å¿…é ˆï¼‰
Resource = "arn:aws:ecr:<region>:<account_id>:repository/<repo_name>"

# æœ€çµ‚: å‹•çš„å‚ç…§ï¼ˆimportå®Œäº†å¾Œã«å¤‰æ•°åŒ–ï¼‰
Resource = data.terraform_remote_state.ecr.outputs.repository_arns
```

**3-2. å‚ç…§æ–¹æ³•ã®å„ªå…ˆé †ä½**
1. `data source` - åŒä¸€AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆå†…ã§ã®å‹•çš„å‚ç…§
2. `terraform_remote_state` - ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é–“ã®å‡ºåŠ›å€¤å‚ç…§
3. å¤‰æ•°æ¸¡ã— - ä¸Šä½ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‹ã‚‰ã®å€¤æ³¨å…¥

**3-3. remote_stateå‚ç…§ã®å®Ÿè£…**
```hcl
data "terraform_remote_state" "iam" {
  backend = "s3"
  config = {
    bucket = "${var.env}-${var.aws_account_id}-<project>-tfstate"
    key    = "iam/terraform.tfstate"
    region = var.region
  }
}

locals {
  role_name = data.terraform_remote_state.iam.outputs.role_name
}
```

#### Phase 4: æ—¢å­˜ç®¡ç†å ´æ‰€ã‹ã‚‰ã®ã‚¹ãƒ†ãƒ¼ãƒˆå‰Šé™¤

**4-1. terraform state rmã‚³ãƒãƒ³ãƒ‰ã§å‰Šé™¤**
```bash
cd <old_service>/dev
terraform state rm 'module.<module>.aws_iam_role_policy_attachment.policies["key"]'
terraform state rm 'module.<module>.aws_iam_role_policy.policies["key"]'
```

**æ³¨æ„äº‹é …:**
- `removed`ãƒ–ãƒ­ãƒƒã‚¯ã¯`for_each`ã®ã‚­ãƒ¼æŒ‡å®šãŒã§ããªã„ãŸã‚ä½¿ç”¨ä¸å¯
- å¿…ãš`terraform state rm`ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨
- å‰Šé™¤å¾Œã¯`terraform plan`ã§è©²å½“ãƒªã‚½ãƒ¼ã‚¹ãŒæ¶ˆãˆã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª

#### Phase 5: æ¤œè¨¼ã¨æœ€é©åŒ–

**5-1. No changesã®ç¢ºèª**
```bash
# æ–°ã—ã„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ç¢ºèª
cd <service>/dev
terraform plan -var-file=../../env/dev.tfvars
# "No changes" ã‚’ç¢ºèª

# å¤ã„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ã‚‚ç¢ºèª
cd <old_service>/dev
terraform plan -var-file=../../env/dev.tfvars
# state rmã—ãŸãƒªã‚½ãƒ¼ã‚¹ãŒæ¶ˆãˆã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
```

**5-2. æ­£å¸¸æ€§ç¢ºèªå¾Œã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤**
```bash
# å¤ã„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‹ã‚‰è©²å½“è¨­å®šã‚’å‰Šé™¤
# ä¾‹: iam/<env>/iam.tf ã‹ã‚‰ç§»è¡Œã—ãŸãƒãƒªã‚·ãƒ¼ã® locals ã‚’å‰Šé™¤
```

### ãƒªã‚½ãƒ¼ã‚¹èª¿æŸ»ã®æ‰‹é †

#### AWSã‚³ãƒ³ã‚½ãƒ¼ãƒ«/CLIã§ç¢ºèªã™ã¹ãæƒ…å ±
```bash
# IAMãƒ­ãƒ¼ãƒ«ã«ã‚¢ã‚¿ãƒƒãƒã•ã‚Œã¦ã„ã‚‹managed policyç¢ºèª
aws iam list-attached-role-policies --role-name <role_name>

# IAMãƒ­ãƒ¼ãƒ«ã®inline policyä¸€è¦§ç¢ºèª
aws iam list-role-policies --role-name <role_name>

# inline policyã®å†…å®¹å–å¾—
aws iam get-role-policy --role-name <role_name> --policy-name <policy_name>
```

**ç¢ºèªé …ç›®:**
1. ãƒªã‚½ãƒ¼ã‚¹ã®ARN/ID
2. ã‚¢ã‚¿ãƒƒãƒã•ã‚Œã¦ã„ã‚‹ãƒãƒªã‚·ãƒ¼ä¸€è¦§ï¼ˆmanaged/inlineï¼‰
3. inline policyã®å†…å®¹ï¼ˆJSONï¼‰
4. ä¾å­˜é–¢ä¿‚ï¼ˆã©ã®ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰å‚ç…§ã•ã‚Œã¦ã„ã‚‹ã‹ï¼‰

#### Terraformã‚¹ãƒ†ãƒ¼ãƒˆã§ç¢ºèªã™ã¹ãæƒ…å ±
```bash
# ç¾åœ¨ã©ã“ã§ç®¡ç†ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
cd <service>/<env>
terraform state list | grep <resource_name>

# ãƒªã‚½ãƒ¼ã‚¹ã®è©³ç´°æƒ…å ±å–å¾—
terraform state show 'module.<module>.aws_iam_role_policy["key"]'
```

### å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰ä¾‹ï¼ˆIAMãƒãƒªã‚·ãƒ¼ç§»è¡Œï¼‰

```bash
# Phase 1: Importå®Ÿè¡Œ
cd <new_service>/<env>
terraform init
terraform plan -var-file=../../env/<env>.tfvars
terraform apply -var-file=../../env/<env>.tfvars
rm import.tf

# Phase 2-3: æ¤œè¨¼
terraform plan -var-file=../../env/<env>.tfvars  # No changesç¢ºèª

# Phase 4: æ—§ã‚¹ãƒ†ãƒ¼ãƒˆå‰Šé™¤
cd ../../<old_service>/<env>
terraform state list | grep <resource_name>  # å‰Šé™¤å¯¾è±¡ç¢ºèª
terraform state rm 'module.<module>.aws_iam_role_policy_attachment.policies["key"]'
terraform state rm 'module.<module>.aws_iam_role_policy.inline_policies["key"]'

# Phase 5: æœ€çµ‚ç¢ºèª
cd ../../<new_service>/<env>
terraform plan -var-file=../../env/<env>.tfvars  # No changes
cd ../../<old_service>/<env>
terraform plan -var-file=../../env/<env>.tfvars  # å‰Šé™¤ç¢ºèª
```

### Phase 2è©³ç´°: ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹é€ ä½œæˆ

#### æ—¢å­˜ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‚è€ƒã«ã™ã‚‹å ´åˆ
```bash
# é¡ä¼¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆECR/GitLabãªã©ï¼‰ã®æ§‹é€ ã‚’ç¢ºèª
ls -la modules/ecr/
ls -la modules/gitlab/

# æ–°è¦ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
mkdir -p modules/<new_service>
mkdir -p <new_service>/<env>

# å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
touch modules/<new_service>/main.tf
touch modules/<new_service>/variables.tf
# outputs.tf ã¯ä»–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‹ã‚‰ã®å‚ç…§ãŒå¿…è¦ãªå ´åˆã®ã¿ä½œæˆ
```

#### ã‚¼ãƒ­ã‹ã‚‰ä½œæˆã™ã‚‹å ´åˆã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
å‚è€ƒ: `modules/ecr/main.tf`, `modules/gitlab/main.tf` ã® for_each ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¸è¥²

### ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼ã¨å¯¾å‡¦æ³•

#### import IDå½¢å¼ã‚¨ãƒ©ãƒ¼
**ç—‡çŠ¶:**
```
Error: invalid role name
ValidationError: The specified value for roleName is invalid
```

**åŸå› :** import IDã®åŒºåˆ‡ã‚Šæ–‡å­—ãŒé–“é•ã£ã¦ã„ã‚‹

**å¯¾å‡¦:**
- managed policy attachment: `<role_name>/<policy_arn>` (ã‚¹ãƒ©ãƒƒã‚·ãƒ¥)
- inline policy: `<role_name>:<policy_name>` (ã‚³ãƒ­ãƒ³)
- åŒºåˆ‡ã‚Šæ–‡å­—ã‚’é–“é•ãˆãªã„ã“ã¨

#### No changes ã«ãªã‚‰ãªã„
**ç—‡çŠ¶:** importå¾Œã« `terraform plan` ã§å·®åˆ†ãŒå‡ºã‚‹

**åŸå› :** ãƒãƒªã‚·ãƒ¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®JSONå½¢å¼ãŒå¾®å¦™ã«ç•°ãªã‚‹ï¼ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®é †åºã€ä¸è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãªã©ï¼‰

**å¯¾å‡¦:**
1. `terraform state show` ã§æ—¢å­˜ã®è¨­å®šã‚’ç¢ºèª
2. `Statement` ã®é †åºã‚’æ—¢å­˜è¨­å®šã«åˆã‚ã›ã‚‹
3. ä¸è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆ`Sid` ãªã©ï¼‰ã‚’å‰Šé™¤ã¾ãŸã¯è¿½åŠ 
4. `jsonencode()` ã®å‡ºåŠ›ã¨ AWS ä¸Šã®å®Ÿéš›ã®å€¤ã‚’æ¯”è¼ƒ

#### å¾ªç’°å‚ç…§ã‚¨ãƒ©ãƒ¼
**ç—‡çŠ¶:** `Error: Cycle` ã¾ãŸã¯ `depends_on` é–¢é€£ã‚¨ãƒ©ãƒ¼

**åŸå› :** moduleãŒlocalsã‚’å‚ç…§ã—ã€localsãŒmoduleã‚’å‚ç…§ã—ã¦ã„ã‚‹

**å¯¾å‡¦:**
- importå®Œäº†ã¾ã§ã¯ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ç¶­æŒ
- å¤‰æ•°åŒ–ãƒ»å‹•çš„å‚ç…§ã¯Phase 3ï¼ˆimportå®Œäº†å¾Œï¼‰ã«å®Ÿæ–½

#### removed blockã‚¨ãƒ©ãƒ¼
**ç—‡çŠ¶:**
```
Error: Resource instance keys not allowed
```

**åŸå› :** `removed` ãƒ–ãƒ­ãƒƒã‚¯ã¯ `for_each` ã®ã‚­ãƒ¼æŒ‡å®šãŒã§ããªã„

**å¯¾å‡¦:** `terraform state rm` ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨

### å®Ÿè£…ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

1. **æ®µéšçš„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**: ä¸€åº¦ã«è¤‡æ•°ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’å¤‰æ›´ã›ãšã€1ã¤ãšã¤å®Œæˆã•ã›ã‚‹
2. **importå®Œäº†ã¾ã§ã¯ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰**: "No changes"ã«ãªã‚‹ã¾ã§æ—¢å­˜ã®è¨­å®šå€¤ã‚’ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã§ç¶­æŒ
3. **importå®Œäº†å¾Œã«å¤‰æ•°åŒ–**: remote_stateã‚„å¤‰æ•°å‚ç…§ã¯å¿…ãšimportæˆåŠŸå¾Œã«å®Ÿæ–½
4. **æ¤œè¨¼ã®å¾¹åº•**: å„æ®µéšã§terraform planã‚’å®Ÿè¡Œã—ã€æ„å›³ã—ãªã„å¤‰æ›´ãŒãªã„ã“ã¨ã‚’ç¢ºèª
5. **å‚è€ƒãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æ´»ç”¨**: æ–°è¦ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆæ™‚ã¯æ—¢å­˜ã®é¡ä¼¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹é€ ã‚’å‚è€ƒã«ã™ã‚‹

````
:::

## AIé–‹ç™ºã‚’çµ‚ãˆã¦
Claude Codeã¯ã‚‚ã®ã™ã”ãè‰¯ã„ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã«ãªã‚Šãã†ã§ã™ã€‚
ãªã‚Šãã†ã§ã™ãŒã€æ¨©é™ã‚’ã©ã“ã¾ã§è¨±ã—ã¦ã‚ã’ã‚‹ã®ã‹ãŒè€ƒãˆæ‰€ã ã¨ã‚‚æ„Ÿã˜ã¾ã—ãŸã€‚
ã©ã®AIãŒã„ã„ã‹ã©ã†ã‹ã®è­°è«–ã‚‚ã§ããšã«Claude Codeä¸€ç‚¹å¼µã‚Šã¿ãŸã„ãªæ„Ÿã˜ã§é–‹ç™ºã—ãŸã®ã§ã™ãŒ
ã»ã‹ã«ã‚‚è‰¯ã„AIãŒã‚ã‚Œã°æ•™ãˆã¦æ¬²ã—ã„ã§ã™(ãƒ¡ãƒªãƒƒãƒˆãƒ‡ãƒ¡ãƒªãƒƒãƒˆã‚‚æ·»ãˆã¦)ã€‚