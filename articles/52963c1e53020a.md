---
title: "GA4ã§åé›†ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ãªãŒã‚‰Analytics Data API ã§å–å¾—ã™ã‚‹"
emoji: "ğŸ¡"
type: "tech"
topics:
  - "php"
  - "ga4"
published: true
published_at: "2022-08-08 15:48"
---

:::message alert
ã“ã®è¨˜äº‹ã¯è‡ªåˆ†ãŒç¤¾å†…ã§ã¾ã¨ã‚ã¦ã„ãŸã‚‚ã®ã‚’è»¢è¼‰ã—ã¦ãŠã‚Šã¾ã™ã€‚
æƒ…å ±ãŒå¤ã„æã‚ŒãŒã‚ã‚Šã¾ã™ã€‚ã”äº†æ‰¿ãã ã•ã„ã€‚
æŠ•ç¨¿æ—¥ï¼š2022/02/04
:::

ã“ã¡ã‚‰ã®è¨˜äº‹ã®ç¶šã
https://zenn.dev/ryomaryoma1010/articles/1474df8fd78c1e

# ã¯ã˜ã‚ã«
APIã«å‡ºåŠ›ã—ã¦ã»ã—ããªã„ãƒ‡ãƒ¼ã‚¿ã‚’åãå‡ºã—ã¦ã—ã¾ã†ã®ã§ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹æ–¹æ³•ã‚’èª¿ã¹ãŸã€‚
åŸºæœ¬çš„ã«ã¯googleã®ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã«è¼‰ã£ã¦ã„ã‚‹é€šã‚Šã ãŒã€è‹±èªãªä¸Šã«ç†è§£ã™ã‚‹ã®ã«æ™‚é–“ãŒã‹ã‹ã£ãŸã€‚

### Analytics Data Apiã«ã¤ã„ã¦

https://developers.google.com/analytics/devguides/reporting/data/v1

# dimensionFilter/metricFilter
ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã¯runReportãƒ¡ã‚½ãƒƒãƒ‰ã®å¼•æ•°ã«dimensionFilterã‚ã‚‹ã„ã¯metricFilterã‚’ã‚­ãƒ¼ã«æŒ‡å®šã™ã‚‹ã€‚

https://developers.google.com/analytics/devguides/reporting/data/v1/rest/v1beta/properties/runReport

# å®Ÿè£…

ä»Šå›ã€è¡Œã„ãŸã„ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã¯ä¸‹è¨˜
* ãƒ‡ã‚£ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã®å€¤ãŒ"ç©ºæ–‡å­—"ã‚ã‚‹ã„ã¯"(not set)"ã‚’é™¤ã

å®Ÿè£…ã—ãŸã®ãŒä¸‹è¨˜ã‚³ãƒ¼ãƒ‰
â€»GA4ã«ã¯äºˆã‚ã€ã‚«ã‚¹ã‚¿ãƒ ãƒ‡ã‚£ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³productcodeã‚’è¨­å®šã—ã¦ã„ã¾ã™ã€‚

```php
$response = $client->runReport([
    'property' => {APIã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®ç§˜å¯†éµ},
    'dateRanges' => [
        new DateRange([
            'start_date' => '7daysAgo',
            'end_date' => 'yesterday',
        ]),
    ],
    'dimensions' => [
        new Dimension([
            'name' => 'customEvent:productcode',
        ]),
    ],
    'metrics' => [
        new Metric([
            'name' => 'screenPageViews',
        ]),
        new Metric([
            'name' => 'totalUsers',
        ]),
    ],
    'dimensionFilter' =>
        new FilterExpression([
            'and_group' => new FilterExpressionList([
                'expressions' => [
                    new FilterExpression([
                        'not_expression' => new FilterExpression([
                            'filter' => new Filter([
                                'field_name' => 'customEvent:productcode',
                                'string_filter' => new StringFilter([
                                    'match_type' => 1,
                                    'value' => '',
                                ]),
                            ]),
                        ])
                    ]),
                    new FilterExpression([
                        'not_expression' => new FilterExpression([
                            'filter' => new Filter([
                                'field_name' => 'customEvent:productcode',
                                'string_filter' => new StringFilter([
                                    'match_type' => 1,
                                    'value' => '(not set)',
                                ]),
                            ]),
                        ])
                    ]),
                ],
            ]),
        ]),
```

dimensionFilterã‚’ã‚­ãƒ¼ã«ã€FilterExpressionã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ç´°ã‹ã„ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°è¨­å®šã‚’è¡Œã£ã¦ã„ã‚‹ã€‚
ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å¼•æ•°ã§ã€ã•ã‚‰ã«andã€orã€notç­‰è¨­å®šãŒã§ãã‚‹ã€‚
 https://developers.google.com/analytics/devguides/reporting/data/v1/rest/v1beta/FilterExpression

# çµæœ
### ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å‰

```
# php data/analyticsDataApi.php 
Report result: 
array(6) {
  [0]=>
  array(3) {
    ["productcode"]=>
    string(9) "(not set)"
    ["screenPageViews"]=>
    string(3) "182"
    ["totalUsers"]=>
    string(1) "7"
  }
  [1]=>
  array(3) {
    ["productcode"]=>
    string(7) "00021"
    ["screenPageViews"]=>
    string(2) "20"
    ["totalUsers"]=>
    string(1) "7"
  }
  [2]=>
  array(3) {
    ["productcode"]=>
    string(7) "00007"
    ["screenPageViews"]=>
    string(1) "2"
    ["totalUsers"]=>
    string(1) "6"
  }
  [3]=>
  array(3) {
    ["productcode"]=>
    string(0) ""
    ["screenPageViews"]=>
    string(1) "1"
    ["totalUsers"]=>
    string(1) "2"
  }
  [4]=>
  array(3) {
    ["productcode"]=>
    string(2) "21"
    ["screenPageViews"]=>
    string(1) "0"
    ["totalUsers"]=>
    string(1) "1"
  }
  [5]=>
  array(3) {
    ["productcode"]=>
    string(7) "00004"
    ["screenPageViews"]=>
    string(1) "0"
    ["totalUsers"]=>
    string(1) "5"
  }
}
```

### ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¾Œ

```
# php data/analyticsDataApi.php 
Report result: 
array(4) {
  [0]=>
  array(3) {
    ["productcode"]=>
    string(7) "00021"
    ["screenPageViews"]=>
    string(2) "20"
    ["totalUsers"]=>
    string(1) "7"
  }
  [1]=>
  array(3) {
    ["productcode"]=>
    string(7) "00007"
    ["screenPageViews"]=>
    string(1) "2"
    ["totalUsers"]=>
    string(1) "6"
  }
  [2]=>
  array(3) {
    ["productcode"]=>
    string(2) "21"
    ["screenPageViews"]=>
    string(1) "0"
    ["totalUsers"]=>
    string(1) "1"
  }
  [3]=>
  array(3) {
    ["productcode"]=>
    string(7) "00004"
    ["screenPageViews"]=>
    string(1) "0"
    ["totalUsers"]=>
    string(1) "5"
  }
}
```

ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãŒã‹ã‹ã£ãŸã“ã¨ã§ã€ç©ºæ–‡å­—ã¨(not set)ãŒæ¶ˆãˆãŸã€‚

# å‚è€ƒ
https://developers.google.com/analytics/devguides/reporting/data/v1

https://developers.google.com/analytics/devguides/reporting/data/v1/rest/v1beta/properties/runReport

https://developers.google.com/analytics/devguides/reporting/data/v1/rest/v1beta/FilterExpression