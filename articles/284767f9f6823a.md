---
title: "æ§‹ç¯‰æ¸ˆã¿ã®awsç’°å¢ƒã‚’terraformåŒ–ã§ããŸã®ã§tipsã‚’ç´¹ä»‹ã—ãŸã„"
emoji: "ğŸ˜Š"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["aws", "terraform"]
published: true
---

:::message
ã“ã®è¨˜äº‹ã«ã¯ä¸€éƒ¨ç”ŸæˆAIã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ç®‡æ‰€ãŒã‚ã‚Šã¾ã™ã€‚
:::

## ã¯ã˜ã‚ã«
æ¥­å‹™ã§AWSç’°å¢ƒã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å†…ã§æ§‹ç¯‰ã—ãŸã®ã§ã™ãŒã€terraformã§ã‚³ãƒ¼ãƒ‰ç®¡ç†ã§ãã‚‹ã‚ˆã†ã«ã—ãŸã„ã¨ã„ã†è¦æœ›ãŒã‚ã‚Šã€terraformåŒ–ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã—ãŸã€‚
AWSã®çµŒé¨“3ãƒ¶æœˆãã‚‰ã„ã€terraformã¯æœªçµŒé¨“ãªãŒã‚‰ã€ãªã‚“ã¨ã‹terraformåŒ–ã«ã“ãã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚ãã®ã¨ãã«ä¾¿åˆ©ã ã¨æ„Ÿã˜ãŸtipsã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

## importãƒ–ãƒ­ãƒƒã‚¯
importãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½¿ã£ã¦æ—¢å­˜ã®AWSç’°å¢ƒã‚’importã—ã¾ã™ã€‚
importã—ãŸã„ãƒªã‚½ãƒ¼ã‚¹ã®importãƒ–ãƒ­ãƒƒã‚¯ã‚’import.tfã«ä½œæˆã—ã¾ã™ã€‚
ãã—ã¦`terraform plan`ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦`terraform apply`ã§tfstateã«importãŒå®Œäº†ã—ã¾ã™ã€‚

```hcl
import {
  to = aws_s3_bucket.example
  id = "my-existing-bucket"
}
```

ä»¥ä¸‹ã§importæ™‚ã®`terrafom plan`ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚

:::message
`terraform import`ã‚³ãƒãƒ³ãƒ‰ã¯ä½¿ã£ã¦ã„ãªã„ã®ã§æœ¬è¨˜äº‹ã§ã¯è§¦ã‚Œã¾ã›ã‚“
:::

### terraform plan
`terraform plan`ã‚³ãƒãƒ³ãƒ‰ã§å®Ÿè¡Œè¨ˆç”»ã‚’ç¢ºèªã—ã¾ã™ã€‚plançµæœã«å•é¡ŒãŒãªã‘ã‚Œã°applyã‚’ã—ã¦ã€tfstateãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ã—ã¾ã™ã€‚
ã¾ãŸã€ã‚³ãƒãƒ³ãƒ‰ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§importæ–¹æ³•ã‚’é¸æŠã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ç§ã¯ä»¥ä¸‹ã®2ã¤ã®importã®ã‚„ã‚Šæ–¹ã§æ—¢å­˜ãƒªã‚½ãƒ¼ã‚¹ã®terraformåŒ–ã‚’è¡Œã„ã¾ã—ãŸã€‚

- ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãªã—
- -generate-config-outã‚ªãƒ—ã‚·ãƒ§ãƒ³

#### ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãªã—

ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã—ãªã„å ´åˆã€resourceãƒ–ãƒ­ãƒƒã‚¯ã‚’ã‚ã‚‰ã‹ã˜ã‚å®šç¾©ã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ãã—ã¦planã®å®Ÿè¡Œçµæœã‚’å‚è€ƒã«ã€resourceãƒ–ãƒ­ãƒƒã‚¯ã®å®šç¾©ã‚’ä¿®æ­£ã—ãªãŒã‚‰å·®åˆ†ã‚’åŸ‹ã‚ã¦ã„ãã¾ã™ã€‚

```hcl:import.tf
import {
  to = aws_s3_bucket.example
  id = "my-existing-bucket"
}
```

```hcl:s3.tf
resource "aws_s3_bucket" "example" {
  bucket = "my-existing-bucket"
  acl    = "private"
  # å¿…è¦ã«å¿œã˜ã¦ä»¥ä¸‹ã®ã‚ˆã†ãªå±æ€§ã‚’è¿½åŠ ã—ã¦ãŠãã¨å·®åˆ†ãŒå°‘ãªããªã‚‹
  # force_destroy = false
  # versioning {
  #   enabled = false
  # }
}
```

```bash
# plançµæœã‚’è¦‹ãªãŒã‚‰resourceã‚’æ§‹æˆã—ã¦å·®åˆ†ã‚’åŸ‹ã‚ã¦ã„ã
terraform plan
```

plançµæœãŒå•é¡Œãªã‘ã‚Œã°ã€`terraform apply`ã‚’ã—ã¦tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€importä½œæ¥­ã‚’å®Œäº†ã•ã›ã¾ã™ã€‚
importå®Œäº†å¾Œã¯importãƒ–ãƒ­ãƒƒã‚¯ã‚’å‰Šé™¤ã‚ã‚‹ã„ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã•ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã®importæ–¹æ³•ã¯ã€ä»¥ä¸‹ã®ã¨ãã«æœ‰åŠ¹ã§ã™ã€‚
- ã™ã§ã«ã‚ã‚‹ç¨‹åº¦ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–ã‚’çµ‚ãˆãŸterraformã‚’æµç”¨ã—ã¦åˆ¥ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’importã—ãŸã„ã¨ã
- é–‹ç™ºç’°å¢ƒã¯æ¸ˆã‚“ã§ã„ã¦ã€ãã“ã‹ã‚‰æœ¬ç•ªç’°å¢ƒã«å±•é–‹ã—ãŸã„ã€‚


#### -generate-config-outã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«ã‚ˆã‚‹è‡ªå‹•ç”Ÿæˆ

```bash
terraform plan -generate-config-out=generated.tf
```

ã“ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä»˜ä¸ã™ã‚‹ã“ã¨ã§importã—ãŸã„ãƒªã‚½ãƒ¼ã‚¹ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ã€‚

```hcl:generated.tf
resource "aws_s3_bucket" "example" {
  bucket = "my-existing-bucket"
  acl    = "private"

  tags = {
    "Name" = "my-existing-bucket"
  }
}
```

ãã®å¾Œã€ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã«å•é¡Œãªã‘ã‚Œã°`terraform apply`ã‚’ã—ã¦tfstateãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€importä½œæ¥­ã‚’å®Œäº†ã•ã›ã¾ã™ã€‚
importå®Œäº†å¾Œã¯importãƒ–ãƒ­ãƒƒã‚¯ã‚’å‰Šé™¤ã‚ã‚‹ã„ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã•ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
å¤§å¤‰ä¾¿åˆ©ã§ã™ãŒã€ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ãªãƒ‡ãƒ¼ã‚¿ãªã®ã§è¤‡é›‘ãªAWSç’°å¢ƒã®terraformåŒ–ã¨ãªã‚‹ã¨ã€é©å®œå¤‰æ•°åŒ–ã‚„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–ã‚’è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã‚’importã—ã¦ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–ã—ã¦ãƒ»ãƒ»ãƒ»ã¨ãªã‚‹ã¨çµæ§‹å¤§å¤‰ã§ã™ã€‚

ã“ã®importæ–¹æ³•ã¯ä»¥ä¸‹ã®ã¨ãã«ä¾¿åˆ©ã§ã™ã€‚
- ã¾ã£ãŸãã®0ã‹ã‚‰ãƒªã‚½ãƒ¼ã‚¹ã‚’terraformåŒ–ã™ã‚‹ã¨ã

## terraform_remote_state
terraformåŒ–ã—ãŸãƒªã‚½ãƒ¼ã‚¹ãŸã¡ã«ä¾å­˜é–¢ä¿‚ã‚’æŒãŸã›ã‚‹ãŸã‚ã«ä½¿ã„ã¾ã™ã€‚
ä¾‹ãˆã°ECSã®task_definitionã‚’å®šç¾©ã™ã‚‹æ™‚ã«taskExecutionRoleã¨taskRoleã«å¯¾è±¡ã¨ãªã‚‹iamã®arnã‚’iamã®remote_stateã‚’ä½œæˆã™ã‚‹ã“ã¨ã§iamã®arnã‚’å¤‰æ•°åŒ–ã™ã‚‹ã¨ã„ã†æ„Ÿã˜ã§ã™ã€‚

iamã®æƒ…å ±ã‚’ä»–ãƒªã‚½ãƒ¼ã‚¹ã§å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€iamã«outputãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½œæˆã—ã¾ã™ã€‚

```hcl
# filepath: iam/outputs.tf
output "task_role_arn" {
  value       = aws_iam_role.task_role.arn
  description = "ARN of the ECS task role"
}

output "task_execution_role_arn" {
  value       = aws_iam_role.task_execution_role.arn
  description = "ARN of the ECS task execution role"
}
```

outputã‚’ä½œæˆã—ãŸã‚‰ã€ä¸€åº¦`terraform apply`ã‚’ã—ã¦tfstateã«outputã‚’ç™»éŒ²ã•ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```bash
# å®Ÿè¡Œè¨ˆç”»ã®ç¢ºèª
terraform plan
# å•é¡Œãªã‘ã‚Œã°apply
terraform apply
```

ECSã«iamã®remote_stateãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½œæˆã—ã¾ã™ã€‚
remote_stateã‚’çµŒç”±ã™ã‚‹ã“ã¨ã§ã€iamã®æƒ…å ±ã‚’ECSã¯å—ã‘å–ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```hcl
# filepath: ecs/main.tf
data "terraform_remote_state" "iam" {
  backend = "s3"
  config = {
    bucket = "my-terraform-state-bucket"
    key    = "iam/terraform.tfstate"
    region = "ap-northeast-1"
  }
}

resource "aws_ecs_task_definition" "app" {
  family                   = "app-task"
  # iamã®outputã§å®šç¾©ã—ãŸå¤‰æ•°ãŒä½¿ãˆã‚‹
  task_role_arn            = data.terraform_remote_state.iam.outputs.task_role_arn
  # iamã®outputã§å®šç¾©ã—ãŸå¤‰æ•°ãŒä½¿ãˆã‚‹
  execution_role_arn       = data.terraform_remote_state.iam.outputs.task_execution_role_arn
  network_mode             = "awsvpc"
  requires_compatibilities = ["FARGATE"]

  container_definitions = jsonencode([
    {
      name  = "app"
      image = "amazonlinux:2"
      cpu   = 256
      memory = 512
      essential = true
      portMappings = [{ containerPort = 80, hostPort = 80 }]
    }
  ])
}
```

## stateç®¡ç†
tfstateã®ç¢ºèªã‚’ã™ã‚‹ã¨ãã«ä½¿ã†ã‚³ãƒãƒ³ãƒ‰ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

### state show
æ—¢å­˜ã‚¹ãƒ†ãƒ¼ãƒˆå†…ã®ãƒªã‚½ãƒ¼ã‚¹ã®è©³ç´°ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ãƒªã‚½ãƒ¼ã‚¹ã®å±æ€§ç¢ºèªã‚„ã€importå¾Œã®ç¢ºèªã«ä¾¿åˆ©ã§ã™ã€‚

```bash
# ä¾‹: S3 ãƒã‚±ãƒƒãƒˆã®ã‚¹ãƒ†ãƒ¼ãƒˆè©³ç´°ã‚’è¡¨ç¤º
terraform state show aws_s3_bucket.example

# å‡ºåŠ›ä¾‹
id = my-existing-bucket
arn = arn:aws:s3:::my-existing-bucket
bucket = my-existing-bucket
acl = private
...
```

### state list
ç¾åœ¨ã® tfstate ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å…¨ãƒªã‚½ãƒ¼ã‚¹ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ä¸€è¦§ã‚’å–å¾—ã—ã¾ã™ã€‚

```bash
terraform state list

# å‡ºåŠ›ä¾‹:
# aws_s3_bucket.example
# aws_iam_role.task_role
# module.ecs.aws_ecs_task_definition.app
```

### state rm
tfstate ã‹ã‚‰ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ä¸Šã‹ã‚‰å®Ÿéš›ã«ãƒªã‚½ãƒ¼ã‚¹ãŒå‰Šé™¤ã•ã‚Œã‚‹ã‚ã‘ã§ã¯ãªãã€ã‚ãã¾ã§tfstateã®ç®¡ç†ã‹ã‚‰é›¢ã™ã ã‘ã§ã™ã€‚

```bash
# ä¾‹: tfstate ã‹ã‚‰å‰Šé™¤
terraform state rm aws_s3_bucket.example
```

ä»¥ä¸‹ã®ã¨ãã«ä½¿ã„ã¾ã™ã€‚
- èª¤ã£ã¦importã—ã¦ã—ã¾ã£ãŸãƒªã‚½ãƒ¼ã‚¹ã‚’stateã‹ã‚‰å¤–ã™
- å¤–éƒ¨ç®¡ç†ã«ç§»è¡Œã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã®stateã‚’åˆ‡ã‚Šé›¢ã™

### state mv
resourceã®åå‰ã‚’å¤‰æ›´ã—ãŸéš›ã€ç´ã¥ã„ã¦ã„ã‚‹tfstateã®ãƒªã‚½ãƒ¼ã‚¹åã‚‚å¤‰æ›´ã™ã‚‹ã®ã«ä½¿ã„ã¾ã™ã€‚

```bash
terraform state mv aws_s3_bucket.example aws_s3_bucket.renamed_example
```

### movedãƒ–ãƒ­ãƒƒã‚¯
ä¸Šè¨˜ã®`terraform state mv`ã¨ç”¨é€”ã¯åŒã˜ã§ã™ã€‚
ã—ã‹ã—ã€ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½¿ã†ã“ã¨ã§ãƒªãƒãƒ¼ãƒ ã®å±¥æ­´ã‚’ã‚³ãƒ¼ãƒ‰ä¸Šã«æ®‹ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

```hcl
# ä¾‹: moved ãƒ–ãƒ­ãƒƒã‚¯
moved {
  from = aws_s3_bucket.example
  to   = aws_s3_bucket.renamed_example
}
```


## ãŠã‚ã‚Šã«
terraformã€æœ€åˆã¯å…¨ç„¶æ„å‘³ã‚ã‹ã‚‰ãªã‹ã£ãŸã®ã§ã™ãŒã€ç†è§£ã—ã¦ã„ãã”ã¨ã«AWSã®ä½¿ç”¨ã¸ã®ç†è§£ã‚‚æ·±ã‚ã‚‹ã“ã¨ãŒã§ããŸã®ã§ã‚„ã£ã¦ã‚ˆã‹ã£ãŸã§ã™ã€‚